#! /usr/bin/env bqn

util â† â€¢Import "util.bqn"
Numâ€¿Posâ€¿SVGâ€¿Geâ€¿Textâ€¿TSizeâ€¿Pathâ€¿Backgroundâ€¿Outlineâ€¿Legendâ€¿Tick â† util

input â† â€¢wdpathâŠ¸â€¢file.AtÂ¨ â€¢args
n â† â‰ input

Read â† {
  ToNats â† ((>âŸœÂ«0âŠ¸â‰¤) / 0(0âŠ¸â‰¤Ã—Ã—âŸœ10âŠ¸+)`âŠ¢) Â· 10âŠ¸â‰¤âŠ¸(Â¬âŠ¸Ã—-âŠ£) -âŸœ'0'
  pr â† "profile" âˆ¨Â´âˆ˜â·âŠ‘ l â† â€¢file.Lines ğ•©
  c â† { Â¬pr ? 3 ; mâ†âŒˆÂ´nâ†1+Â´Â¨'.'=l â‹„ lâˆ¾Â¨â†©â¥Šâˆ˜/âŸœ(â‰" 0")Â¨m-n â‹„ m }
  tab â† âˆ˜â€¿c â¥Š ToNats '.'âŠ¸â‰ âŠ¸/ âˆ¾l
  prâ—¶âŸ¨0â€¿2âŠ¸âŠ, âŠâˆ¾Â·+`3âŠ¸â†“âŸ© â‰ Ã·âŸœ1e3âŒ¾(1â†“â‰) 4 â†“ tab
}

dat â† ReadÂ¨ input
x â† âŠâŠ‘dat
! âˆ§Â´(xâ‰¡âŠ)Â¨1â†“dat

fname â† ((Â»âˆ¨`)âˆ˜=âŸœ'_'âŠ¸/ Â·âˆ§`âˆ˜â‰ âŸœ'.'âŠ¸/ â€¢file.Name)Â¨ â€¢args
namesâ€¿colorsâ€¿rhf â† util.ProcName fname
col â† "stroke"âŠ¸â‹ˆÂ¨ colors

width â† 512
off â† 50â€¿40 â‹„ end â† 20â€¿46

gr â† "stroke-width=1.2|font-size=14px|text-anchor=middle"
TT â† < TSizeâŠ¸âˆ¾âŸœ(Pos(widthÃ·2)âŠ¸â‹ˆ)Â´âŠ¸Text

logyâ†âˆ§Â´1=ynâ†1-Ëœâ‰ Â¨dat  # Don't use log-scale y to show parts
Log â† â‹†â¼âŒ¾(logyâŠ‘âŠ‘â€¿âŠ¢)
win â† -Ëœ`Â¨ bounds â† 0âŒ¾(âŠ‘1âŠ‘âŠ¢)âŸ(Â¬logy) (âŒŠÂ´â‰âŒˆÂ´)âˆ˜â¥ŠÂ¨ Log xy â† âŸ¨x, âˆ¾1â†“Â¨datâŸ©
dim â† width (âŠ£â‹ˆÃ—) 0.55
out â† (-off)â‰dim+off+end
padb â† logy Ã— padi  â† 0â€¿20
Scale â† padi+(dim-padb+padi)Ã— ({Â¬ğ•}âŒ¾(1âŠ¸âŠ‘) {ğ•©Ã·Ëœğ•¨-ËœâŠ¢}Â´Â¨ win) {ğ•ğ•©}Â¨ Log
line â† (<â‰Ë˜)â‰1â—‹NumÂ´ Scale xy
lstyle â† (((â†“â‰"stroke-width"â€¿"1.4")âŠËœâˆŠâŒ¾âŒ½) âˆ¾Â¨ âŠâŸœcol) /yn

â€¢OutÂ¨ (â¥Šout) SVG gr Ge âŸ¨
  Background out
  âŸ¨18,Â¯19âŸ© TT "Sorting random 4-byte integers"
  âŸ¨
    "Size" TextËœ Pos 0â€¿26+dimÃ—0.5â€¿1
    "Time (ns / value)" TextËœ "transform"â€¿"rotate(-90)"âˆ¾Pos 0â€¿32-ËœâŒ½dimÃ—0â€¿Â¯0.5
  âŸ©
  Tick {
    offâ‡0â€¿0 â‹„ dimâ‡dim
    orientâ‡"vh"
    tpos â‡ Scale ticks â† âŸ¨10â‹†2+â†•6, {logy?5âˆ¾10Ã—1+â†•8;5Ã—1+â†•20}âŸ©
    ttext â‡ âŸ¨1e3âŠ¸<â—¶Numâ€¿("1e"âˆ¾'0'+Â·âŒŠ0.5+10â‹†â¼âŠ¢)Â¨, NumâŸ© {ğ•ğ•©}Â¨ ticks
  }
  { logy?âŸ¨âŸ©;
    Area â† âˆ¾âˆ˜â¥Š ("M "âˆ¾"HV"Â»"L "â‰1) âˆ¾Â¨ (Num dim-padb)âŠ¸âˆ¾
    st â† "opacity"â€¿"0.2"âŠ¸â‰Â¨(yn-1)/"fill"âŠ¸â‹ˆÂ¨colors
    "stroke=none" Ge st PathâŸœAreaÂ¨ (Â¬âˆŠ/yn)/line
  }âˆ¾âŸ¨
    "stroke-width=2.6|fill=none" Ge lstyle PathâŸœ('M'âŒ¾âŠ‘âˆ˜âˆ¾Â·â¥Š "L "âˆ¾Â¨â‰1âŠ¢)Â¨ line
  âŸ©
  Outline 0â€¿0â‰dim
  Legend {
    label â‡ names â‹„ isRH â‡ rhf
    place â‡ 10â€¿6
    width â‡ 134 â‹„ spacing â‡ 18 â‹„ pad â‡ 6
    Samples â‡ "stroke-width=2.6" Ge col â‰âŠ¸PathâŸœ(âˆ¾"M h"âˆ¾Â¨Num)Â¨ (8âˆ¾âˆ¾âŸœ22)Â¨
  }
âŸ©
