#! /usr/bin/env bqn

"Input filename required" ! 1â‰¤â‰ â€¢args
input â† â€¢wdpath â€¢file.At âŠ‘â€¢args

# Parse the file
Parse â† {
  hâ€¿d â† (âŠ‘â‹ˆ2âŠ¸â†“) â€¢file.Lines ğ•©
  c â† +`'|'=h
  m â† Â¬âˆ§Ë"| "âˆŠËœ>d
  g â† 1-ËœmÃ—c âŠ +Ë(1+â†•âˆ˜â‰ )âŠ¸Ã— "Name"â€¿"Distribution"â€¿"Average" âˆ¨Â´âˆ˜â·âŒœ c âŠ” h
  <Ë˜ â‰ (0<Â·â‰ Â¨âŠË˜)âŠ¸/ (âˆ¨`' 'âŠ¸â‰ )âŠ¸/Â¨ > gâŠ¸âŠ”Â¨d
}
nameâ€¿distâ€¿avg â† Parse input
! (â‰ âˆ˜âŠ‘â¥ŠÂ¨Â·âŠ£âŒœËœ`âŒ¾âŒ½â·Â¨)âŠ¸â‰¡ âŠÂ¨distâ€¿name
PD â† {
  tâ†-â‰ oâ†" order" â‹„ ğ•©â†“Ëœâ†©tÃ—oâ‰¡tâ†‘ğ•©
  mâ†âŠ¢Â´âŠ¸<(0Â¨e)(â‰ `Â»â‰ âŠ¢)bâ†ğ•©(â‰ âˆ˜âŠ¢â†‘â·)Ëœeâ†"ending"
  (-Â´"Aa")âŠ¸+âŒ¾âŠ‘ (bâ‰¥m)/ğ•©+(bâˆ§m)Ã—'.'-ğ•©
}
names â† â·name
dists â† PDÂ¨â·dist

# SVG utilities
Enc â† {
  DeNest â† {(3âŒŠâ‰¡)â—¶âŸ¨!âˆ˜0,â‹ˆ,âŠ¢,âˆ¾ğ•ŠÂ¨âŸ© â¥Šğ•©}
  open â† âˆ¾âŸ¨"<",ğ•¨,">"âŸ©
  closeâ† âˆ¾âŸ¨"</", (âˆ§`ğ•¨â‰ ' ')/ğ•¨, ">"âŸ©
  l â† 1 < dâ†â‰¡ğ•©
  âˆ¾ open ({"  "âŠ¸âˆ¾Â¨(âˆ¾DeNestÂ¨)âŸ(3â‰¤d)â¥Šğ•©}âŸl ğ•©){ğ•¨â€¿ğ•—â€¿ğ•©}â—‹(â¥Šâˆ˜<âŸl) close
}
At1 â† " " âˆ¾ {âˆ¾âŸ¨ğ•¨,"='",ğ•©,"'"âŸ©}Â´
Attr â† âˆ¾âŸœ(âˆ¾ <âˆ˜At1â‰1)
At â† {
  _s â† {((+`Ã—Â¬)âŠ¸-ğ•—âŠ¸=)âŠ¸âŠ”}
  ğ•¨ >âŠ˜(âˆ¾âŸœ(âˆ¾At1Â¨)) '='_sÂ¨ '|'_s ğ•©
}
Elt â† {âˆ¾âŸ¨"<",ğ•©,"/>"âŸ©}Attr
FmtNum â† (âˆ§`4â¥ŠâŸœ1âŠ¸Â»'.'âŠ¸â‰ )âŠ¸/âˆ˜â€¢Reprâš‡0
Pos â† âŸ¨"x","y"âŸ© â‰Ë˜ FmtNum
SVG â† {
  a â† âŸ¨"viewBox",1â†“âˆ¾' 'âˆ¾Â¨FmtNum ğ•¨âŸ©âˆ¾"height"â€¿"width"â‰Ë˜FmtNum 1.5Ã—âŒ½2â†“ğ•¨
  a âˆ¾â†© "xmlns"â€¿"http://www.w3.org/2000/svg"
  ("svg" Attr a) Enc ğ•©
}

# Create the plot
max â† âŒˆÂ´ avg â€¢BQNÂ¨â†©
ticks â† (â†•1+âŒŠ)âŒ¾(Ã·âŸœ10) maxns â† 1e4Ã—max

Ge â† "g"âŠ¸AtâŠ¸Enc

nnâ€¿nd â† â‰ Â¨namesâ€¿dists
btâ†bsâ†7 â‹„ gsâ†12+nnÃ—bs
w â† 14 +      (w0â†100) + tw â† 6 + pwâ†400-6
h â† 68 + h1 â† (h0â† 56) + ph â† ndÃ—gs
wh â† wâ€¿h
tpos â† w0+pwÃ—ticksÃ·maxns

colors â† "#6ad"â€¿"#c7d"â€¿"#b9e"â€¿"#cc6"â€¿"#da4"â€¿"#24851d"

Rdim â† Posâˆ˜âŠâˆ¾"width"â€¿"height"â‰Ë˜Â·FmtNumâŠ¢Ë
Rect â† "rect" Elt RdimâŠ˜(AtâŠ¸âˆ¾âŸœRdim)
Text â† "text"Attr"dy"â€¿"0.33em"âŠ¸âˆ¾
TT â† < (Text("font-size"â‹ˆFmtNumâˆ˜âŠ‘âˆ¾"px"Ë™)âˆ¾Â·Pos(w0+pwÃ·2)â‹ˆ1âŠ‘âŠ¢)âŠ¸Enc

gh â† h0+gsÃ—0.5+â†•nd
bh â† gh +âŒœ bs Ã— (â†•-2Ã·Ëœ-âŸœ1)nn
bars â† bh Rectâˆ˜{âŸ¨w0,ğ•¨-btÃ·2âŸ©â‰ğ•©â€¿bt}Â¨ ndâ€¿nnâ¥ŠpwÃ—avgÃ·max

ls â† 11+bs
lh â† lsÃ—1+â†•nn
lw â† 150
rhs â† (At"font-weight=bold|stroke-width=0.6|stroke=#211")âˆ¾"fill"â‹ˆÂ¯1âŠ‘colors
ltr â† "transform=translate("âˆ¾")"âˆ¾Ëœâˆ¾âŸœ","âŠ¸âˆ¾Â´FmtNum âŸ¨w0+tw-10+lw,h0+300âŸ©
legend â† (ltrâˆ¾"|text-anchor=start|font-size=13px") Ge âŸ¨
  "fill=white|stroke=#111" Rect 0â€¿0â‰âŸ¨lw,lsÃ—1+nnâŸ©
  "stroke=#111" Ge colors "fill"âŠ¸â‹ˆâŠ¸("rect" Elt âˆ¾âŸœRdim)âŸœ{10â€¿ğ•©â‰18â€¿bt}Â¨ lh-btÃ·2
  (rhsâŠ¸âˆ¾âŒ¾(Â¯1âŠ¸âŠ‘)36 Posâˆ˜â‹ˆÂ¨lh) TextâŠ¸EncÂ¨ "Robin Hood"âŒ¾(Â¯1âŠ¸âŠ‘)names
âŸ©

â€¢OutÂ¨ (0â€¿0âˆ¾wh) SVG "text-anchor=middle|font-size=14px|fill=#111" Ge âˆ¾â¥ŠÂ¨ âŸ¨
  <"fill=white" Rect 0â€¿0â‰wh
  âŸ¨20,h0-37âŸ© TT "The Big Bad Wolfsort benchmark"
  âŸ¨15,h0-14âŸ© TT "Sort 100,000 4-byte integers, average of 100"
  âŸ¨15,h1+31âŸ© TT "Nanoseconds per element"
  âŸ¨11,h1+51âŸ© TT "i5-6200U CPU @ 2.30GHz; compiled with g++ -O3"
  "stroke-width=0.3|stroke=#555" Ge ("path"Elt"d"â‹ˆÂ·âˆ¾"M v"âˆ¾Â¨Â·FmtNumâˆ¾âŸœh0â€¿ph)Â¨ 1â†“tpos
  "font-size=11px" Ge tpos ("text"AttrÂ·Posâ‹ˆâŸœ(h1+13))âŠ¸EncÂ¨ FmtNum ticks
  "text-anchor=end" Ge ((w0-5)Posâˆ˜â‹ˆÂ¨gh) TextâŠ¸EncÂ¨ dists
  "stroke=#111" Ge colors ("g"Attr"fill"âŠ¸â‹ˆ)âŠ¸EncÂ¨ <Ë˜â‰bars
  <"stroke=#111|fill=none" Rect w0â€¿h0â‰twâ€¿ph
  legend
âŸ©
