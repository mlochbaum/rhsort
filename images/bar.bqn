#! /usr/bin/env bqn

util â† â€¢Import "util.bqn"
Numâ€¿Posâ€¿SVGâ€¿Geâ€¿Rectâ€¿Textâ€¿TSizeâ€¿Backgroundâ€¿Outlineâ€¿Legendâ€¿Tick â† util

"Input filename required" ! 1â‰¤â‰ â€¢args
input â† â€¢wdpath â€¢file.At âŠ‘â€¢args

# Parse the file
Parse â† {
  hâ€¿d â† (âŠ‘â‹ˆ2âŠ¸â†“) (âˆ¨`âŒ¾âŒ½'|'âŠ¸=)âŠ¸/Â¨ ('|'=(âŠ‘1âŠ¸â†‘)Â¨)âŠ¸/ â€¢file.Lines ğ•©
  c â† +`'|'=h
  m â† Â¬âˆ§Ë"| "âˆŠËœ>d
  g â† 1-ËœmÃ—c âŠ +Ë(1+â†•âˆ˜â‰ )âŠ¸Ã— "Name"â€¿"Distribution"â€¿"Average" âˆ¨Â´âˆ˜â·âŒœ c âŠ” h
  <Ë˜ â‰ (0<Â·â‰ Â¨âŠË˜)âŠ¸/ (âˆ¨`' 'âŠ¸â‰ )âŠ¸/Â¨ > gâŠ¸âŠ”Â¨d
}
nameâ€¿distâ€¿avg â† Parse input
! (â‰ âˆ˜âŠ‘â¥ŠÂ¨Â·âŠ£âŒœËœ`âŒ¾âŒ½â·Â¨)âŠ¸â‰¡ âŠÂ¨distâ€¿name
PD â† {
  tâ†-â‰ oâ†" order" â‹„ ğ•©â†“Ëœâ†©tÃ—oâ‰¡tâ†‘ğ•©
  Abbr â† {
    mâ†âŠ¢Â´âŠ¸<(0Â¨e)(â‰ `Â»â‰ âŠ¢)bâ†ğ•©(â‰ âˆ˜âŠ¢â†‘â·)Ëœeâ†ğ•¨
    (bâ‰¥m)/ğ•©+(bâˆ§m)Ã—'.'-ğ•©
  }
  (-Â´"Aa")âŠ¸+âŒ¾âŠ‘ "ending" Abbr "om" AbbrâŸ(âŠ‘'%'âˆŠâŠ¢) ğ•©
}
namesâ€¿colorsâ€¿isRH â† util.ProcName Â¯4 â†“Â¨ â·name
dists â† PDÂ¨â·dist

# Create the plot
max â† âŒˆÂ´ avg â€¢BQNÂ¨â†©

nnâ€¿nd â† â‰ Â¨namesâ€¿dists
btâ†bsâ†7 â‹„ gsâ†12+nnÃ—bs
w â† 14 +      (w0â†100) + tw â† 6 + pwâ†400-6
h â† 68 + h1 â† (h0â† 56) + ph â† ndÃ—gs
wh â† wâ€¿h

_cBar â† { "stroke=#111" Ge colors "fill="âŠ¸âˆ¾âŠ¸ğ”½Â¨ ğ•© }

TT â† < TSizeâŠ¸âˆ¾âŸœ(Pos(w0+pwÃ·2)âŠ¸â‹ˆ)Â´âŠ¸Text

gh â† h0+gsÃ—0.5+â†•nd
bh â† gh +âŒœ bs Ã— (â†•-2Ã·Ëœ-âŸœ1)nn
bars â† ndâ€¿nnâ¥ŠpwÃ—avgÃ·max

â€¢OutÂ¨ (0â€¿0âˆ¾wh) SVG "text-anchor=middle|font-size=14px|fill=#111" Ge âŸ¨
  Background 0â€¿0â‰wh
  âŸ¨20,h0-37âŸ© TT "The Big Bad Wolfsort benchmark"
  âŸ¨15,h0-14âŸ© TT "Sort 100,000 4-byte integers, average of 100"
  âŸ¨15,h1+31âŸ© TT "Nanoseconds per element"
  âŸ¨11,h1+51âŸ© TT "i5-6200U CPU @ 2.30GHz; compiled with g++ -O3"
  Tick {
    offâ‡w0â€¿h0 â‹„ dimâ‡twâ€¿ph
    orientâ‡"v"
    ticks â† (â†•1+âŒŠ)âŒ¾(Ã·âŸœ10) maxns â† 1e4Ã—max
    tpos â‡ âŸ¨w0+pwÃ—ticksÃ·maxnsâŸ©
    ttext â‡ âŸ¨Num ticksâŸ©
  }
  "text-anchor=end" Ge ((w0-5)Posâˆ˜â‹ˆÂ¨gh) TextÂ¨ dists
  Ge _cBar <Ë˜â‰ bh Rectâˆ˜{âŸ¨w0,ğ•¨-btÃ·2âŸ©â‰ğ•©â€¿bt}Â¨ bars
  Outline w0â€¿h0â‰twâ€¿ph
  Legend {
    isRH â‡ isRH â‹„ label â‡ names
    width â‡ 150
    place â‡ âŸ¨w0+tw-10+width,h0+85âŸ©
    pad â‡ 2 Ã·Ëœ spacing â‡ 11+bs
    Samples â‡ RectâŸœ{10â€¿(ğ•©-btÃ·2)â‰18â€¿bt} _cBar
  }
âŸ©
