#! /usr/bin/env bqn

EncodeLZW â† {
  dmax â† 2â‹†12
  kâ†ğ•¨ â‹„ dâ†â†•0 â‹„ râ†â†•0
  Add â† {cğ•Šw:
    i â† d âŠ‘âˆ˜âŠ wc â† (dmaxÃ—w)+c
    { i<â‰ d ? k+i ;
      { dmax>k+â‰ d ? d âˆ¾â†© wc ; @ }
      r âˆ¾â†© w
      c
    }
  }
  r âˆ¾ AddÂ´âŒ½ğ•©
}

EncPixels â† {
  c â† 2â‹†ğ•¨
  d â† (c+2) EncodeLZW ğ•©
  Pack â† {â¥Šâ‰ >2|âŒŠâˆ˜Ã·âŸœ2âŸ(â†•ğ•¨) ğ•©}
  s â† câˆ¾dâˆ¾c+1
  m â† 12âŒŠâŒˆ2â‹†â¼(c+1)+â†•â‰ s
  2âŠ¸Ã—âŠ¸+ËœË â‰â†‘â€¿8â¥Šâˆ¾ (ğ•¨+â†•âˆ˜â‰ )âŠ¸(PackÂ¨) (m-ğ•¨) âŠ” s
}
SplitBlocks â† {
  0 âˆ¾Ëœ âˆ¾ â‰ âŠ¸âˆ¾Â¨ (255âŒŠâˆ˜Ã·Ëœâ†•âˆ˜â‰ )âŠ¸âŠ” ğ•©
}

# GIF with colors ğ•¨ and list of delayâ€¿posâ€¿inds ğ•©
EncodeGIF â† { colors ğ•Š frames:
  size â† âŒ½â‰¢2âŠ‘âŠ‘frames
  cc â† 2â‹†1+â†•8
  cf â† 1âŒˆcc âŠ‘âˆ˜â‹ 1-Ëœâ‰ colors
  "Too many colors" ! cf<â‰ cc
  colors â†‘Ëœâ†© cfâŠ‘cc

  Enc2 â† âˆ¾256(|â‹ˆâŒŠâˆ˜Ã·Ëœ)Â¨âŠ¢
  Block â† {delayâ€¿posâ€¿inds: âˆ¾âŸ¨
    # Graphic control extension
    33â€¿249, 4, 4, Enc2 delay, 255, 0
    # Image descriptor
    44
    Enc2 posâˆ¾â—‹âŒ½â‰¢inds
    0      # No local colors
    1+cf
    SplitBlocks (1+cf) EncPixels â¥Šinds
  âŸ©}

  âˆ¾âŸ¨
    # Bit depth, background, color list
    "GIF89a"-@, Enc2 size, 128+17Ã—cf, 0, 0, â¥Šcolors

    # For animation
    33â€¿255, 11, "NETSCAPE2.0"-@, 3, 1, 255â€¿255, 0

    âˆ¾ BlockÂ¨ frames

    59 # End
  âŸ©
}

# Draw the algorithm
wâ€¿nâ€¿hâ€¿p â† 230â€¿70â€¿60â€¿10 â‹„ eâ†3
hh â† p+2Ã—h
bar â† 1 + n (â€¢MakeRand 0).Range h
ind0 â† (â‹ˆËœ<e) / âŸ¨-hh,wâŸ©â†‘((âŒ½â†•h)<âŒœbar)
# Insert to buffer
Mv â† {sâ†eÃ—ğ•©â€¿1 â‹„ fâ€¿tâ†ğ•¨ â‹„ âŸ¨eÃ—fâ‹ˆËœhh-ğ•©, sâ¥Š2âŸ©â€¿âŸ¨eÃ—tâ‹ˆËœh-ğ•©, sâ¥Š3âŸ©}
updates â† > ((â†•âˆ˜â‰ â‹ˆÂ¨âŒŠâˆ˜Ã—âŸœ(wÃ·h)) MvÂ¨ âŠ¢) bar
# Filter buffer
Fl â† {sâ†eÃ—ğ•©â€¿1 â‹„ fâ€¿tâ†ğ•¨ â‹„ âŸ¨eÃ—fâ‹ˆËœh-ğ•©, sâ¥Š4âŸ©â€¿âŸ¨eÃ—tâ‹ˆËœh+p, (-eÃ—h)â†‘sâ¥Š3âŸ©}
updates âˆ¾â†© > ((âˆ§âŒŠâˆ˜Ã—âŸœ(wÃ·h)â‹ˆÂ¨â‹âˆ˜â‹) FlÂ¨ âˆ§) bar
updates â†© â¥Š 2â€¿8 âˆ¾Â¨â‰1 updates

col â† >âŸ¨0â€¿0â€¿0,0â€¿0â€¿255,10â€¿10â€¿50,0â€¿255â€¿0,10â€¿50â€¿10âŸ©
"robinhood.gif" â€¢file.Bytes col EncodeGIF âŸ¨30,0â€¿0,ind0âŸ© <âŠ¸âˆ¾ updates
