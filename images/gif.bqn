#! /usr/bin/env bqn

# Gif utils
EncodeLZW â† {
  dmax â† 2â‹†12
  kâ†ğ•¨ â‹„ dâ†â†•0 â‹„ râ†â†•0
  Add â† {cğ•Šw:
    i â† d âŠ‘âˆ˜âŠ wc â† (dmaxÃ—w)+c
    { i<â‰ d ? k+i ;
      { dmax>k+â‰ d ? d âˆ¾â†© wc ; @ }
      r âˆ¾â†© w
      c
    }
  }
  r âˆ¾ AddÂ´âŒ½ğ•©
}

EncPixels â† {
  c â† 2â‹†ğ•¨
  d â† (c+2) EncodeLZW ğ•©
  Pack â† {â¥Šâ‰ >2|âŒŠâˆ˜Ã·âŸœ2âŸ(â†•ğ•¨) ğ•©}
  s â† câˆ¾dâˆ¾c+1
  m â† 12âŒŠâŒˆ2â‹†â¼(c+1)+â†•â‰ s
  2âŠ¸Ã—âŠ¸+ËœË â‰â†‘â€¿8â¥Šâˆ¾ (ğ•¨+â†•âˆ˜â‰ )âŠ¸(PackÂ¨) (m-ğ•¨) âŠ” s
}
SplitBlocks â† {
  0 âˆ¾Ëœ âˆ¾ â‰ âŠ¸âˆ¾Â¨ (255âŒŠâˆ˜Ã·Ëœâ†•âˆ˜â‰ )âŠ¸âŠ” ğ•©
}

# GIF with colors ğ•¨ and list of delayâ€¿posâ€¿inds ğ•©
EncodeGIF â† { colors ğ•Š frames:
  size â† âŒ½â‰¢2âŠ‘âŠ‘frames
  cc â† 2â‹†1+â†•8
  cf â† 1âŒˆcc âŠ‘âˆ˜â‹ 1-Ëœâ‰ colors
  "Too many colors" ! cf<â‰ cc
  colors â†‘Ëœâ†© cfâŠ‘cc

  Enc2 â† âˆ¾256(|â‹ˆâŒŠâˆ˜Ã·Ëœ)Â¨âŠ¢
  Block â† {delayâ€¿posâ€¿inds: âˆ¾âŸ¨
    # Graphic control extension
    33â€¿249, 4, 4, Enc2 delay, 255, 0
    # Image descriptor
    44
    Enc2 posâˆ¾â—‹âŒ½â‰¢inds
    0      # No local colors
    1+cf
    SplitBlocks (1+cf) EncPixels â¥Šinds
  âŸ©}

  âˆ¾âŸ¨
    # Bit depth, background, color list
    "GIF89a"-@, Enc2 size, 128+17Ã—cf, 0, 0, â¥Šcolors

    # For animation
    33â€¿255, 11, "NETSCAPE2.0"-@, 3, 1, 255â€¿255, 0

    âˆ¾ BlockÂ¨ frames

    59 # End
  âŸ©
}

# Draw the algorithm
col â† >âŸ¨ # Colors
  0â€¿0â€¿0,               # 0    Black
  16â€¿3â€¿230, 8â€¿7â€¿58,    # 1 2  Blue
  45â€¿166â€¿36, 12â€¿48â€¿10, # 3 4  Green
  137â€¿37â€¿14            # 5    Orange
âŸ©
wâ€¿nâ€¿hâ€¿p â† 260â€¿90â€¿60â€¿10 â‹„ eâ†3 â‹„ outlâ†5  # Parameters
hh â† p+2Ã—h
Dist â† âŒŠ (hÃ·14) Ã— Â·((1.5Ã—Â·â€¢math.Sin (3.5Ã—Ï€)âŠ¸Ã—) + 15Ã—Ã—Ëœ) Ã·âŸœh
bar â† 3 + Dist n (â€¢MakeRand 0).Range h
Seqâ†âŒ½âˆ˜â†•âŠ¸(<âŒœ) â‹„ EEâ†(â‹ˆËœ<e)/âŠ¢
ind0 â† (âŠ¢â†‘ËÂ·-âŒ¾âŠ(2â€¿1Ã—outl)+âŒœâ‰¢) EE âŸ¨hh,wâŸ©â†‘h Seq bar
thr â† 2Ã—blkâ†8

# Insert to buffer
bp â† âŒŠ (w-thr) Ã— Ã·âŸœ(âŒˆÂ´) -âŸœ(âŒŠÂ´) bar
buf â† wâ¥Šâˆ
steal â† â†•0
Insert â† {ğ•Šfâ€¿j0â€¿b: sâ†eÃ—bâ€¿1
  iâ†{j+â†©bâ‰¥kâ†ğ•©âŠ‘bufâ‹„ğ•ŠâŸ(âˆâ‰ k)1+ğ•©}jâ†j0
  câ†i-j0
  vâ†@ â‹„ buf ({vâ†©ğ•©}bâŠ¸Â»)âŒ¾((jâ†“â†•i)âŠ¸âŠ)â†©
  mâ†âŠ¢Â´v
  âŸ¨2, fâ‹ˆh-b, sâ¥Š2âŸ©â€¿âŸ¨8, jâ‹ˆhh-m, EE 3Ã—m Seq vâŸ© âˆ¾ {thr>c?âŸ¨âŸ©;
    thrâ†©blk
    câŒŠâŒ¾(Ã·âŸœblk)â†©
    stâ†â‰ steal
    buf (âˆÂ¨âŠ£{stealâˆ¾â†©ğ•©})âŒ¾((j0+â†•c)âŠ¸âŠ)â†©
    âŸ¨2, j0â‹ˆhh-m, (eÃ—mâ€¿c)â¥Š0 âŸ©â€¿âŸ¨20, stâ‹ˆ0, EE 5Ã—h Seq (-c)â†‘stealâŸ©
  }
}
updates â† âˆ¾ <âˆ˜InsertË˜ â‰>(â†•â‰ bar)â€¿bpâ€¿bar

# Filter buffer
Filter â† {dğ•Šfâ€¿tâ€¿b: sâ†eÃ—bâ€¿1
  âŸ¨2, fâ‹ˆhh-b, sâ¥Š4âŸ©â€¿âŸ¨d, tâ‹ˆ0, (-eÃ—h)â†‘sâ¥Š3âŸ©
}
bi â† /âˆâ‰ buf
updates âˆ¾â†© â¥Š (2Ã—(â‰ buf)(Â«-âŠ¢)bi) FilterË˜ â‰>âŸ¨bi,bar(-+â†•âˆ˜âŠ¢)â—‹â‰ bi,biâŠbufâŸ©

# Merge
arr â† stealâˆ¾biâŠbuf
Merge â† {ğ•Šiâ€¿lâ€¿n:
  slâ†@ â‹„ arr âˆ§âˆ˜{slâ†©ğ•©}âŒ¾(nâ†‘iâ†“âŠ¢)â†©
  cp â† âŸ¨40, 0â‹ˆh+p, EE 5Ã—h Seq lâ†‘slâŸ©
  r â† (lâŠ¸<âŠ¸(iâŠ¸Ã—âŠ¸+â‹ˆÂ¨(h+p)Ã—Â¬âˆ˜âŠ£) â†•n) â‹ˆÂ¨ {EE(-h)â†‘ğ•©â€¿1â¥Š4}Â¨ sl
  (â‹ˆcp) âˆ¾ â¥Š (slâ‹âŠ¸âŠ2âˆ¾Â¨r) â‰Ë˜ (i+â†•n) {âŸ¨4, ğ•¨â€¿0, EE(-h)â†‘ğ•©â€¿1â¥Š3âŸ©}Â¨ âˆ§sl
}
ms â† âˆ¾ (â†•âˆ˜âŒˆâŒ¾(2â‹†â¼âŠ¢))âŠ¸({dâ†2Ã—ğ•¨â‹„âˆ¾âŸœğ•¨â€¿dÂ¨â†•âˆ˜âŒˆâŒ¾(Ã·âŸœd)ğ•©}Â¨) 4
updates âˆ¾â†© âˆ¾ MergeÂ¨ (msâŒ¾(Ã·âŸœblk) â‰ steal) âˆ¾ â‹ˆ0âˆ¾â‰ Â¨stealâ€¿arr

updates 80âŒ¾âŠ‘âŒ¾(Â¯1âŠ¸âŠ‘)â†©
updates (outl+eÃ—âŒ½)âŒ¾(1âŠ¸âŠ‘)Â¨â†©

"robinhood.gif" â€¢file.Bytes col EncodeGIF âŸ¨30,0â€¿0,ind0âŸ© <âŠ¸âˆ¾ updates
