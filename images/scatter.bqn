#! /usr/bin/env bqn

util â† â€¢Import "util.bqn"
Numâ€¿Posâ€¿SVGâ€¿Geâ€¿Textâ€¿TSizeâ€¿Pathâ€¿Backgroundâ€¿Outlineâ€¿Legendâ€¿Tick â† util
Encâ€¿Eltâ€¿Atâ€¿Rect â† util

"Input filename required" ! 1â‰¤â‰ â€¢args
input â† â€¢wdpath â€¢file.At âŠ‘â€¢args

ToNats â† ((>âŸœÂ«0âŠ¸â‰¤) / 0(0âŠ¸â‰¤Ã—Ã—âŸœ10âŠ¸+)`âŠ¢) Â· 10âŠ¸â‰¤âŠ¸(Â¬âŠ¸Ã—-âŠ£) -âŸœ'0'
Parse â† {
  l â† â€¢file.Lines ğ•©
  t â† âˆ¾âŸœ" of "âŠ¸âˆ¾Â´ Num ToNats âŠ‘l
  t â‹ˆ Â¯1 (â†“ â‹ˆ âŠÃ·1e3Ë™) (Â¯1âˆ¾Ëœ1+â†•11) âŠ â‰ âˆ˜â€¿14 â¥Š ToNats '.'âŠ¸â‰ âŠ¸/ âˆ¾1â†“l
}
âŸ¨title,samplesâ€¿timeâŸ© â† Parse input

ylog â† 0
width â† 512
off â† 50â€¿40 â‹„ end â† 20â€¿46

gr â† "stroke-width=1.2|font-size=14px|text-anchor=middle"

Marker â† "circle" Elt "r"â€¿"2"âˆ¾"cx"â€¿"cy"â‰Ë˜Num
Clip â† <"defs" Enc ("clipPath"At"id=clip") Enc Rect
Dist â† {
  h â† 0(âˆ¾âˆ¾âˆ¾âŸœ(-âŒ½))2(24Ã·4+â†“Â¬-âŠ¸â†“)ğ•¨
  p â† (âˆ¾â—‹(Â¯1âŠ¸â†“)âŸœâŒ½ğ•¨) â‰Ë˜ ğ•©+h
  "Z" âˆ¾Ëœ 'M'âŒ¾âŠ‘ âˆ¾â¥Š "L " âˆ¾Â¨â‰1 Num p
}

Log â† â‹†â¼âŒ¾(ylogâŠ‘âŠ‘â€¿âŠ¢)
win â† -Ëœ`Â¨ bounds â† Log 30â€¿800 â‹ˆ 0â‹ˆâŒˆÂ´time
dim â† width (âŠ£â‹ˆÃ—) 0.55
out â† (-off)â‰dim+off+end
padb â† 1â€¿ylog Ã— padi  â† 10â€¿20
Scale â† padi+(dim-padb+padi)Ã— ({Â¬ğ•}âŒ¾(1âŠ¸âŠ‘) {ğ•©Ã·Ëœğ•¨-ËœâŠ¢}Â´Â¨ win) {ğ•ğ•©}Â¨ Log
dat â† Scale âŸ¨<Ë˜â‰5âŒˆsamples, timeâŸ©

â€¢OutÂ¨ (â¥Šout) SVG gr Ge âŸ¨
  Clip 0â€¿0â‰dim
  Background out
  <((TSize 18)âˆ¾PosâŸ¨widthÃ·2,Â¯19âŸ©) Text "RH criterion, sampling "âˆ¾title
  âŸ¨
    "Score" TextËœ Pos 0â€¿26+dimÃ—0.5â€¿1
    "Time (ns / value)" TextËœ "transform"â€¿"rotate(-90)"âˆ¾Pos 0â€¿32-ËœâŒ½dimÃ—0â€¿Â¯0.5
  âŸ©
  Tick {
    offâ‡0â€¿0 â‹„ dimâ‡dim
    orientâ‡"vh"
    RoundDown â† {(âŠ‘âˆ˜â‹âŸœğ•©-1Ë™)âŠ¸âŠ‘1â€¿2â€¿5Ã—âŒŠâŒ¾(10â‹†â¼âŠ¢)ğ•©}
    tpos â‡ Scale ticks â† âŸ¨
      â¥Š(10â‹†â†•4)Ã—âŒœâˆ§1.5â€¿7âˆ¾1+â†•5
      {ylog ? â¥Š1â€¿10Ã—âŒœâˆ§1.5â€¿7âˆ¾1+â†•5 ; (RoundDown 6Ã·Ëœ1âŠ‘1âŠ‘bounds)Ã—1+â†•15}
    âŸ©
    ttext â‡ âŸ¨1e3âŠ¸<â—¶Numâ€¿("1e"âˆ¾'0'+Â·âŒŠ0.5+10â‹†â¼âŠ¢)Â¨, NumâŸ© {ğ•ğ•©}Â¨ ticks
  }
  "clip-path=url(#clip)" Ge âŸ¨
    "fill=#24851d" Ge (Marker 5âŠ¸âŠ‘âŠ¸â‹ˆ)Â¨Â´ dat
    "fill=#176e10" Ge (â‰"opacity"â€¿"0.6")âŠ¸PathÂ¨ DistÂ¨Â´ dat
  âŸ©
  Outline 0â€¿0â‰dim
âŸ©
